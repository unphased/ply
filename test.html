<!DOCTYPE html>
<html lang="en">
<head>	
	<meta charset="utf-8" />
	
	<title>ply says Hello World!</title>
	
	<!-- Enter a brief description of your page -->
	<meta name="description" content="Test Page for ply.js">
	
	<!-- Define a viewport to mobile devices to use - telling the browser to assume that the page is as wide as the device (width=device-width) and setting the initial page zoom level to be 1 (initial-scale=1.0) -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		
	<link href="css/test.css" rel="stylesheet" media="all" />

	<!-- Do not use these scripts in production (obviously) --> 
	<script src="http://code.jquery.com/jquery-1.8.3.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

	<!-- The all-important --> 
	<script src="ply.js"></script>
</head>
<body>
	<h1><span class="ply_js_title">ply.js</span></h1>
	<div id="debug">Debug div</div>
	<div>Content of page</div>
	<div>Containing div
		<div>level 1 div<div>level 2 div</div></div>
	</div>
	<input type="text" value="text field" />
</body>
<script>

(function() {
    var lastTime = 0;
    var vendors = ['ms', 'moz', 'webkit', 'o'];
    for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
        window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
        window.cancelAnimationFrame = window[vendors[x]+'CancelAnimationFrame'] 
                                   || window[vendors[x]+'CancelRequestAnimationFrame'];
    }
    var datenow = Date.now?Date.now:function(){return (new Date()).getTime();};
    if (!window.requestAnimationFrame)
        window.requestAnimationFrame = function(callback, element) {
            var currTime = datenow();
            var timeToCall = Math.max(0, 16 - (currTime - lastTime));
            var id = window.setTimeout(function() { callback(currTime + timeToCall); }, 
              timeToCall);
            lastTime = currTime + timeToCall;
            return id;
        };
 
    if (!window.cancelAnimationFrame)
        window.cancelAnimationFrame = function(id) {
            clearTimeout(id);
        };
    
    var transform_name = Modernizr.prefixed('transform');
	// be aware this routine sucks CPU a bit -- I use both rAF and window focus listening to make it friendlier
    // I am implementing this as a separate component rather than building it into the library. This is to decouple
    // the debug logic into the test page, and keep the library itself as lean and mean as it can reasonably be.
    function debugdump(time) {
        if (time < 1e12) {
            // we're getting sub-ms time stamp
        }
        // schedule 
        if (document.hasFocus()) 
            requestAnimationFrame(debugdump);
        else console.log("document has lost focus. Stopping debug dump rAF");
        //console.log(Date.now());
        // the HTML debug dump of the data
        var str = "<ul>";
        for (var prop in PLY) {
            str += "<li>";
            str += prop + ": "; 
            str += JSON.stringify(PLY[prop]);
            str += "</li>";
        }
        str += "</ul>";
        $("#debug").html(str);
        // actual debug visualization of pointer locations
        if (!$('#pointer_marker_container').length) {
            $('body').append('<div id="pointer_marker_container"></div>');
        }
        var jmpc = $("#pointer_marker_container");
        var mpc = jmpc[0];
        var ppl = PLY.pointer_state.length;
        while (mpc.children.length < ppl) {
            var ne = document.createElement('DIV');
            ne.className = "pointer_marker";
            mpc.appendChild(ne);
        }
        while (mpc.children.length > ppl) {
            mpc.removeChild(mpc.lastChild);
        }
        for (var i=0; i<ppl; ++i) {
            var ppi = PLY.pointer_state[i];
            mpc.children[i].style[transform_name] = "translate3d("+ppi.x+"px,"+ppi.y+"px,0)";
        }
    }
	requestAnimationFrame(debugdump);
    $(window).focus(function(){
        console.log("Window got focus. Jumpstarting rAF");
        requestAnimationFrame(debugdump);
    });
}());

</script>
</html>